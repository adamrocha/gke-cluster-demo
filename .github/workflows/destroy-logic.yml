name: Check Destroy Condition

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      branch_prefixes:
        description: "Comma-separated branch prefixes that qualify for destroy"
        required: false
        type: string
        default: "delete/,nuke/"
    outputs:
      should_destroy:
        description: "True if branch deletion should trigger Terraform destroy"
        value: ${{ jobs.check.outputs.should_destroy }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should_destroy: ${{ steps.set.outputs.destroy }}
    steps:
      - id: set
        run: |
          prefixes="${{ inputs.branch_prefixes }}"
          destroy=false

          # Check for branch deletion
          if [ "${{ github.event_name }}" = "delete" ] && [ "${{ github.event.ref_type }}" = "branch" ]; then
            branch="${{ github.event.ref }}"
            
            # Check if branch starts with any of the specified prefixes
            IFS=',' read -ra PREFIX_ARRAY <<< "$prefixes"
            for prefix in "${PREFIX_ARRAY[@]}"; do
              if [[ "$branch" == "$prefix"* ]]; then
                destroy=true
                break
              fi
            done
          fi

          echo "destroy=$destroy" >> $GITHUB_OUTPUT