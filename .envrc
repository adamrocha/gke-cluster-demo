#!/usr/bin/env bash

set -euo pipefail

# Project root
export PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# GCP project
export CLOUDSDK_CORE_PROJECT="gke-cluster-458701"

# Detect OS type
OS_TYPE="$(uname -s)"

# General package installer
install_package() {
    local pkg="$1"
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        command -v brew >/dev/null 2>&1 || { echo "Please install Homebrew first."; exit 1; }
        brew install "$pkg"
    elif [[ "$OS_TYPE" == "Linux" ]]; then
        if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y "$pkg"
        elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y "$pkg"
        else
            echo "Unsupported Linux package manager. Install $pkg manually."
            exit 1
        fi
    else
        echo "Unsupported OS: $OS_TYPE"
        exit 1
    fi
}

# Install a tool if missing
ensure_command() {
    local cmd="$1"
    local pkg="${2:-$1}"  # Default package name matches command
    if ! command -v "$cmd" >/dev/null 2>&1; then
        echo "$cmd is not installed. Installing..."
        install_package "$pkg"
    else
        echo "$cmd is already installed."
    fi
}

# Special case installations
ensure_gcloud() {
    if ! command -v gcloud >/dev/null 2>&1; then
        echo "gcloud not found. Installing Google Cloud CLI..."
        if [[ "$OS_TYPE" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y apt-transport-https ca-certificates gnupg curl
            curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
            sudo apt-get update && sudo apt-get install -y google-cloud-cli
        else
            install_package gcloud
        fi
    else
        echo "gcloud is already installed."
    fi
}

ensure_gke_plugin() {
    if ! command -v gke-gcloud-auth-plugin >/dev/null 2>&1; then
        echo "Installing gke-gcloud-auth-plugin..."
        [[ "$OS_TYPE" == "Linux" ]] && sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin
    else
        echo "gke-gcloud-auth-plugin already installed."
    fi
}

# Install main tools
ensure_gcloud
ensure_gke_plugin
ensure_command terraform
ensure_command make
ensure_command kubectl
ensure_command jq
ensure_command vault
ensure_command docker docker.io
ensure_command helm
ensure_command pass

# Vault environment variables
export VAULT_ADDR="$(pass vault/dev/address)"
export VAULT_TOKEN="$(pass vault/dev/token)"
